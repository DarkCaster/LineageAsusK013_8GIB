KERNEL_MODULES_OBJ := $(TARGET_OUT_INTERMEDIATES)/KERNEL_MODULES

TARGET_KERNEL_BINARIES: $(KERNEL_OUT_STAMP) $(KERNEL_CONFIG) $(KERNEL_HEADERS_INSTALL_STAMP)
	@echo "Building Kernel"
	$(MAKE) $(MAKE_FLAGS) -C $(KERNEL_SRC) O=$(KERNEL_OUT) ARCH=$(KERNEL_ARCH) $(KERNEL_CROSS_COMPILE) $(TARGET_PREBUILT_INT_KERNEL_TYPE)

BUILD_KERNEL_MODULES: TARGET_KERNEL_BINARIES
	@echo "Building Kernel Modules"
	$(MAKE) $(MAKE_FLAGS) -C $(KERNEL_SRC) O=$(KERNEL_OUT) ARCH=$(KERNEL_ARCH) $(KERNEL_CROSS_COMPILE) modules
	$(MAKE) $(MAKE_FLAGS) -C $(KERNEL_SRC) O=$(KERNEL_OUT) INSTALL_MOD_PATH=$(KERNEL_MODULES_OBJ) ARCH=$(KERNEL_ARCH) $(KERNEL_CROSS_COMPILE) modules_install

	find $(KERNEL_MODULES_OBJ) -type f -name '*.ko' -exec $(KERNEL_TOOLCHAIN_PATH)strip --strip-unneeded {} ';'
	$(MAKE) $(MAKE_FLAGS) -C $(KERNEL_SRC) O=$(KERNEL_OUT) INSTALL_MOD_PATH=$(KERNEL_MODULES_OBJ) ARCH=$(KERNEL_ARCH) $(KERNEL_CROSS_COMPILE) modules_sign

$(TARGET_KERNEL_MODULES): BUILD_KERNEL_MODULES
	@echo "Copying Kernel Modules"
	find $(KERNEL_MODULES_OBJ) -type f -name '*.ko' -exec cp {} $(KERNEL_MODULES_OUT) ';'
